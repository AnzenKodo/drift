<!doctype html>
<html>
    <head>
        <title>drift/view</title>
        <meta charset="UTF-8" />
        <meta name="color-scheme" content="dark light">
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <style>
            *,::after,::before{box-sizing:border-box}html{line-height:1.15;-webkit-text-size-adjust:100%;-moz-tab-size:4;tab-size:4}hr{height:0;color:inherit}abbr[title]{text-decoration:underline dotted}b,strong{font-weight:bolder}code,kbd,pre,samp{font-family:ui-monospace,SFMono-Regular,Consolas,'Liberation Mono',Menlo,monospace;font-size:1em}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}table{text-indent:0;border-color:inherit}button,input,optgroup,select,textarea{font-family:inherit;font-size:100%;line-height:1.15;margin:0}button,select{text-transform:none}[type=button],[type=reset],[type=submit],button{-webkit-appearance:button}::-moz-focus-inner{border-style:none;padding:0}:-moz-focusring{outline:1px dotted ButtonText}:-moz-ui-invalid{box-shadow:none}legend{padding:0}progress{vertical-align:baseline}::-webkit-inner-spin-button,::-webkit-outer-spin-button{height:auto}[type=search]{-webkit-appearance:textfield;outline-offset:-2px}::-webkit-search-decoration{-webkit-appearance:none}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}summary{display:list-item}
            :root {
                --theme-color: #8AC9FF;
                --theme-color-dark: color-mix(in srgb,var(--theme-color),#000 30%);
                --background-color: #000;
                --foreground-color: #fff;
                --spacing: .6rem;
                --border: .5px solid gray;
                scrollbar-color: var(--foreground-color) var(--background-color);
            }
            *:focus {
                outline: 1px double;
                outline-offset: 1px;
            }
            *::-webkit-scrollbar-track {
                background: var(--background-color);
            }
            *::-webkit-scrollbar-thumb {
                background-color: #888;
            }
            body {
                font-family: monospace;
                font-size: 100%;
                background: black;
                display: flex;
                gap: var(--spacing);
                justify-content: center;
            }
            main {
                width: 35rem;
            }
            aside {
                position: sticky;
                top: .5rem;
                height: 90vh;
                width: 17rem;
            }
            footer {
                grid-area: footer;
                justify-self: center;
            }

            /* Elements */

            a {
                color: var(--theme-color);
                text-decoration: none;
            }
            a:hover {
                text-decoration: underline;
                cursor: pointer;
            }
            a:active {
                color: var(--theme-color-dark);
            }
            button {
                border: .5px solid;
                background: none;
                cursor: pointer;

            }
            button:hover {
                border-style: dashed;
            }
            button:active {
                border-style: dotted;
            }
            textarea {
                width: 100%;
                height: 7rem;
                margin: 0 .3rem 0rem 0;
                padding: 1% 2%;
                background: transparent;
            }
            textarea:hover, input:hover {
                border-style: dashed;
            }
            textarea:active, input:active {
                border-style: dotted;
            }
            img {
                max-width: 100%;
                display: block;
            }
            select {
                background: black;
            }

            #logo:hover {
                cursor: pointer;
                filter: brightness(50%);
            }
            #logo:active {
                border: dotted;
                filter: brightness(75%);
            }

            /* Account */

            #account-options {
                display: none;
                flex-direction: column;
                background-color: #000;
                position: absolute;
                top: 100%;
                left: 0;
                width: 100%;
                border: .5px solid gray;
            }
            #account-options.active {
                display: flex;
            }
            #account .account-option {
                display: flex;
                align-items: center;
                padding: .4rem;
                border-top: 1px solid #333;
                color: white;
            }

            #account .account-option:hover {
                background-color: #333;
            }
            #account .account-name {
                margin: 0;
                font-weight: bold;
            }
            #account img {
                border-radius: 50%;
                width: 2rem;
                margin-right: 10px
            }

            /* Posts */

            #posts article {
                border: var(--border);
                padding: .5rem .5rem;
                margin-bottom: var(--spacing);
            }
            #posts .post_profile {
                display: flex;
                flex-flow: row;
                width: 100%;
            }
            #posts .post_profile_image {
                margin-right: .3rem;
            }
            #posts .post_profile_image img {
                width: 2rem;
                border-radius: 100%;
            }
            #posts .post_profile_info {
                display: flex;
                flex-flow: column;
                width: 15rem;
                flex: 1;
            }
            #posts .post_profile_info_1 {
                display: flex;
                justify-content: space-between;
                margin: .1rem;
                margin-bottom: .1rem
            }
            #posts .post_profile_info_1 time {
                text-align: right;
            }
            #posts .post_content p {
                line-height: 1.2rem;
                margin-top: .3rem;
                margin-bottom: .3rem;
            }
            #posts .post_content img {
                display: block;
                margin: 0rem auto .5rem auto;
            }
            #posts .post_content video {
                max-width: 100%;
                margin: 0 auto;
                margin-top: .3rem;
            }

            .border {
                border: var(--border);
            }
            .margin-btm {
                margin-bottom: var(--spacing);
            }

            div.spacer {
                margin:  0;
            }
            div.spacer-1rem {
                margin: 1rem 0;
            }
        </style>
        <script>
            function ele_get(query) {
                return document.querySelector(query);
            }
            function hexToBytes(hex) {
                return Uint8Array.from(
                    hex.match(/.{1,2}/g).map((byte) => parseInt(byte, 16))
                );
            }
            function bytesToHex(bytes) {
                return bytes.reduce(
                    (str, byte) => str + byte.toString(16).padStart(2, "0"), ""
                )
            }
        </script>
    </head>
    <body>
        <aside>
            <img src="./logo.png" alt="Logo" id="logo" class="border margin-btm">

            <div id="login" class="border margin-btm" style="padding: .4rem .5rem .6rem .5rem;">
                <label>
                    <span style="display: block">Private Key:</span>
                    <input type="password" name="private_key" id="pri_key" style="width: 60%; margin: .5em 0;">
                </label>
                <button style="width: 10%; padding: .2em" onclick="">üìã</button>
                <button style="width: 10%; padding: .2em" onclick="generate_qr(this)">üî≥</button>
                <button style="width: 10%; padding: .2em;" id="toggle_pass" onclick="toggle_password(this)">üôà</button>
                <div id="login_qr"></div>
                <button style="width: 30%;" onclick="gen_pri_key(this)">Generate</button>
                <button type="submit" style="color: var(--theme-color); width: 66%" onclick="login(this)">Login</button>
                <script src="https://cdn.jsdelivr.net/gh/davidshimjs/qrcodejs@gh-pages/qrcode.min.js"></script>
                <script>
                    function generate_qr(ele) {
                        const pri_key = ele_get("#pri_key").value;
                        if (!pri_key) { return }

                        const img = ele_get("#login_qr img")
                        if  (img) { img.remove() }

                        new QRCode(ele_get("#login_qr"), pri_key);
                    }
                    function toggle_password(ele) {
                        const pri_key = ele_get("#pri_key");
                        const log_type = pri_key.type;
                        if (log_type === "password") {
                            pri_key.type = "text";
                            ele.textContent = "üêµ";
                        }
                        if (log_type === "text") {
                            pri_key.type = "password";
                            ele.textContent = "üôà";
                        }
                     }
                    function gen_pri_key(ele) {
                        const pri_key = bytesToHex(nobleSecp256k1.utils.randomPrivateKey());
                        ele_get("#pri_key").value = pri_key;
                        ele_get("#pri_key").type = "text";
                        ele_get("#toggle_pass").textContent = "üêµ";
                    }
                    function login(ele) {
                        localStorage.setItem('pri_key', login_input.value);
                        setupLogin();
                    }
                </script>
                <style>
                    #login_qr img {
                        padding: .5rem;
                        background: white;
                        margin-bottom: .5rem;
                    }
                </style>
            </div>

            <div id="account" style="display: none; position: relative; border: .5px solid gray; cursor: pointer; margin-bottom: .6rem"">
                <div id="account-toggle" style="display: flex; padding: .4rem .4rem; position: relative; flex-direction: column;">
                    <div class="account-main" style="display:flex">
                        <img src="https://i.pinimg.com/564x/c0/06/5c/c0065cbde31f0a768ed1fe201cc72ea1.jpg" alt="Profile Picture">
                        <div style="flex-grow: 1">
                            <p class="account-name" style="margin: 0;"><a>Aman Varma</a></p>
                            <small style="margin: 0;">@AnzenKodo</small>
                        </div>
                        <div style="font-size: 20px; margin-left: 10px;">&#9660;</div>
                    </div>
                    <small style="margin-top: 5px;">grinding hard in mom's basement.</small>
                </div>

                <div id="account-options">
                    <div class="account-option">
                        <img src="https://i.pinimg.com/564x/c0/06/5c/c0065cbde31f0a768ed1fe201cc72ea1.jpg" alt="Profile Picture">
                        <div class="account-info">
                            <p class="account-name"><a>Krishna Yadav</a></p>
                            <small>@kyadav</small>
                        </div>
                    </div>

                    <div class="account-option">
                        <img src="https://i.pinimg.com/564x/c0/06/5c/c0065cbde31f0a768ed1fe201cc72ea1.jpg" alt="Profile Picture">
                        <div class="account-info">
                            <p class="account-name"><a>Nagesh Giri</a></p>
                            <small>@Nagesh</small>
                        </div>
                    </div>

                    <div class="account-option">
                        <div style="border: 1px solid; border-radius: 50%; padding: .5rem .7rem; margin-right: 10px;">+</div>
                        <div class="account-info">
                            <p class="account-name">Add New Account</p>
                        </div>
                    </div>
                </div>
            </div>

            <footer class="border" style="font-size: .6rem; text-align: center; line-height: 1rem; padding: .2rem 0">
                <p style="margin: 0">
                    <strong>Source:</strong> <a href="https://github.com/AnzenKodo/drift">GitHub</a> |
                    <strong>Version:</strong> 0.1 |
                    <strong>License:</strong> <a href="https://spdx.org/licenses/MIT">MIT</a>
                    Made with ‚ù§ in <strong>NalaSopara</strong>
                </p>
            </footer>
        </aside>

        <main>
            <div id="new_post" class="margin-btm">
                <style>
                    #new_post_textbox:empty:before {
                        content: attr(placeholder);
                        color: #888;
                    }
                </style>
                <div contenteditable="true" placeholder="Start typing here..."  id="new_post_textbox" class="border" style="height: 6rem; font-size: .6rem; padding: .5rem; resize: none; overflow-x: auto; white-space: pre-wrap;"></div>
                <script>
                    const new_post_textbox = document.getElementById('new_post_textbox');

                    new_post_textbox.addEventListener('input', function() {
                        new_post_textbox.style.height = '6rem';
                        new_post_textbox.style.height = new_post_textbox.scrollHeight + 'px';
                    });

                    new_post_textbox.addEventListener("paste", function(e) {
                        e.preventDefault();
                        const text = (e.clipboardData || window.clipboardData).getData('text');
                        document.execCommand("insertText", false, text);
                    });

                    new_post_textbox.addEventListener('keydown', function(e) {
                        const selection = window.getSelection();
                        const range = selection.getRangeAt(0);
                        const selectedText = range.toString();

                        if (e.key === 'Tab') {
                            e.preventDefault();
                            const tabSpace = "    ";
                            const tabNode = document
                                .createTextNode("\u00a0\u00a0\u00a0\u00a0");

                            // Insert the tab character at the current cursor position
                            range.insertNode(tabNode);

                            // Move the cursor after the inserted tab
                            range.setStartAfter(tabNode);
                            range.setEndAfter(tabNode);

                            // Clear existing selections and apply the new range
                            selection.removeAllRanges();
                            selection.addRange(range);

                        }
                        if (e.key === 'b' && e.ctrlKey) {
                            e.preventDefault();

                            document.execCommand('bold');

                            if (selectedText.length > 0) {
                                const span = document.createElement('span');
                                span.innerHTML = `**${selectedText}**`;

                                // Replace the selected text with the new span
                                range.deleteContents();
                                // range.insertNode(span);

                                // Set the selection back to the newly inserted content
                                selection.removeAllRanges();
                                selection.addRange(range);
                            }
                        }
                        if (e.ctrlKey && e.key === "Enter") {
                            console.log("Post")
                        }
                    });
                </script>
                <button style="width: 100%">Post</button>
            </div>

            <div id="posts">
                <article>
                    <div class="post_profile">
                        <div class="post_profile_image">
                            <a><img src="https://avatars.githubusercontent.com/u/50282743" alt="Profile image" /></a>
                        </div>
                        <div class="post_profile_info">
                            <div class="post_profile_info_1">
                                <a><span class="name">Aman</span></a> <time class="time">10/23/2012„Éª02:32 PM</time></a>
                            </div>
                            <div class="post_profile_info_2">
                                <small>@AnzenKodo</small>
                            </div>
                        </div>
                    </div>
                    <div class="post_content">
                        <p>> opens spotify, searches "focus music"</br>
                        > sees lofi slop</br>
                        > opens yt, searches "460mm go bang!"</br>
                        <video controls>
                            <source src="vod.mp4" type="video/mp4">
                            Your browser does not support the video tag.
                        </video>
                        > focus mode on
                    </div>
                    <div class="actions">
                        <button class="actions_comment">Comment (3)</button>
                        <button class="actions_react">React</button>
                    </div>
                </article>
                <article>
                    <div class="post_profile">
                        <div class="post_profile_image">
                            <a><img src="https://avatars.githubusercontent.com/u/50282743" alt="Profile image" /></a>
                        </div>
                        <div class="post_profile_info">
                            <div class="post_profile_info_1">
                                <a><span class="name">Aman</span></a> ‚Ä¢ <time class="time">Today</time></a>
                            </div>
                            <div class="post_profile_info_2">
                                <span>@AnzenKodo</small>
                            </div>
                        </div>
                    </div>
                    <div class="post_content">
                        <p>Gonna slove this</p>
                        <img src="https://i1.sndcdn.com/artworks-P59I6SjPgHMVcjEI-jwGxDw-t500x500.jpg">
                    </div>
                    <div class="actions">
                        <button class="actions_comment">Comment (3)</button>
                        <button class="actions_react">React</button>
                    </div>
                </article>
                <article>
                    <div class="posts_profile">
                        <div class="posts_profile_image">
                            <a><img src="https://avatars.githubusercontent.com/u/50282743" alt="Profile image" /></a>
                        </div>
                        <div class="posts_profile_info">
                            <div>
                                <a><span class="name">Aman</span></a> ‚Ä¢ <time class="time">Today</time></a>
                            </div>
                            <div>
                                <span class="username">@AnzenKodo</span>
                            </div>
                        </div>
                    </div>
                    <div class="content">
                        <div class="content">

                        </div>
                    </div>
                    <div class="actions">
                        <button class="actions_comment">Comment (3)</button>
                        <button class="actions_react">React</button>
                    </div>
                </article>
                <article>
                    <a class="profile_image">
                        <img src="https://avatars.githubusercontent.com/u/50282743" alt="Profile image" />
                    </a>
                    <div class="info">
                        <a><span class="name">Aman</span></a> <span class="username">@AnzenKodo</span> ‚Ä¢ <time class="time">Yesterday</time></a>
                    </div>
                    <div class="actions">
                        <button class="actions_react">React</button>
                        <button class="actions_comment">Comment (1)</button>
                    </div>
                </article>
                <article>
                    <a class="profile_image">
                        <img src="https://avatars.githubusercontent.com/u/50282743" alt="Profile image" />
                    </a>
                    <div class="info">
                        <a><span class="name">Aman</span></a> <span class="username">@AnzenKodo</span> ‚Ä¢ <time class="time">12-Sep-2024</time></a>
                    </div>
                    <div class="content">
                        <p>"Victory did not come to the one who played by the rules; it came to the one who made the rules and imposed them on his enemy."<br>-- Genghis Khan</p>
                        <p>"Don‚Äôt waste the rest of your time here worrying about other people‚Äîunless it affects the common good. It will keep you from doing anything useful. You‚Äôll be too preoccupied with what so-and-so is doing, and why, and what they‚Äôre saying, and what they‚Äôre thinking, and what they‚Äôre up to, and all the other things that throw you off and keep you from focusing on your own mind."<br>--Marcus Aurelius
                    </div>
                    <div class="actions">
                        <button class="actions_react">React</button>
                        <button class="actions_comment">Comment (3)</button>
                    </div>
                </article>
                <article>
                    <a class="profile_image">
                        <img src="https://avatars.githubusercontent.com/u/50282743" alt="Profile image" />
                    </a>
                    <div class="info">
                        <a><span class="name">Aman</span></a> <span class="username">@AnzenKodo</span> ‚Ä¢ <time class="time">Today</time></a>
                    </div>
                    <div class="content">
                        <p>Leftism isn‚Äôt supposed to make sense. It‚Äôs supposed to sound nice on paper.</p>
                        </p>"Government giving money to poor people". Sounds nice on paper, but have  horrifying effect on economic.</p>
                    </div>
                    <div class="actions">
                        <button class="actions_react">React</button>
                        <button class="actions_comment">Comment (1)</button>
                    </div>
                </article>
                <article>
                    <a class="profile_image">
                        <img src="https://avatars.githubusercontent.com/u/50282743" alt="Profile image" />
                    </a>
                    <div class="info">
                        <a><span class="name">Aman</span></a> <span class="username">@AnzenKodo</span> ‚Ä¢ <time class="time">Today</time></a>
                    </div>
                    <div class="content">
                        <p>currently writing nostr relay in go. i have come to understand that i have lots of skill issues.</p>
                    </div>
                    <div class="actions">
                        <button class="actions_react">React</button>
                        <button class="actions_comment">Comment (3)</button>
                    </div>
                </article>
                <article>
                    <a class="profile_image">
                        <img src="https://avatars.githubusercontent.com/u/50282743" alt="Profile image" />
                    </a>
                    <div class="info">
                        <a><span class="name">Aman</span></a> <span class="username">@AnzenKodo</span> ‚Ä¢ <time class="time">Today</time></a>
                    </div>
                    <div class="content">
                        <p>you code for money<br>
                        i code for skills<br><br>

                        we are not the same
                        </p>
                    </div>
                    <div class="actions">
                        <button class="actions_react">React</button>
                        <button class="actions_comment">Comment (15)</button>
                    </div>
                </article>
            </div>
        </main>
        <script src="https://bundle.run/noble-secp256k1@1.2.14"></script>
        <script src="https://bundle.run/browserify-cipher@1.0.1"></script>
        <script>
            const { getSharedSecret, schnorr, utils } = nobleSecp256k1;
            const sha256 = nobleSecp256k1.utils.sha256;

            let pri_key = localStorage.getItem("pri_key");
            let pub_key = get_pub_key(pri_key);

            const relay = "ws://cfrelay.haorendashu.workers.dev";
            const ws = new WebSocket(relay);

            const login_input = document.querySelector("#pri_key");
            const login_button = document.querySelector("#login");
            const new_post = document.querySelector("#new_post");
            const toggle_pass = document.querySelector("#toggle_pass");
            const post_textbox = document.querySelector("#post_textbox");
            const accountToggle = document.getElementById('account-toggle');
            const accountOptions = document.getElementById('account-options');
            const account = document.getElementById('account');
            function dateNow() {
                return Math.floor(Date.now() / 1000);
            }
            async function getPublicKey() {
                return await window.nostr.getPublicKey();
            }

            function setupLogin() {
                login_button.style.display = "none";
                account.style.display = "";
                new_post.style.display = "";
            }

            if (localStorage.getItem("pri_key")) {
                setupLogin();
                login()
            } else {
                not_login();
            }

            function not_login() {
            }

            function get_pub_key(pri_key) {
                return nobleSecp256k1.getPublicKey(pri_key, true).substring(2);
            }

            async function login() {

                pri_key = localStorage.getItem("pri_key");
                pub_key = get_pub_key(pri_key);

                ws.addEventListener('open', async (e) => {
                    console.log("connected to " + relay);
                    const sub_id = bytesToHex(
                        nobleSecp256k1.utils.randomPrivateKey()
                    ).substring(0, 16);

                    const filter  = { "authors": [ pub_key ] };
                    const subscription = [ "REQ", sub_id, filter ]
                    console.log('Subscription:', subscription);
                    ws.send(JSON.stringify(subscription));
                });

                ele_get("#new_post_textbox").addEventListener("click", async () => {
                    await sendPubNote();
                });
            }

            async function sendPubNote() {
                const event = {
                    "content": "Hello World!",
                    "created_at": dateNow(),
                    "kind": 1,
                    "tags": [],
                    "pubkey": pub_key,
                }

                const signedEvent = await getSignedEvent(event);
                console.log("signedEvent:", signedEvent);
                ws.send(JSON.stringify(["EVENT", signedEvent]));
            }


            // ws.addEventListener('message', async function(message) {
            //     const [ type, subId, event ] = JSON.parse(message.data);
            //     const { kind, content } = event || {}
            //     if (!event || event === true) return;
            //     console.log('message:', event);
            //     if (kind === 4) {
            //         content = await decrypt(privKey, event.pubkey, content);
            //     }
            //     console.log('content:', content);
            // });

            async function getSignedEvent(event) {
                var eventData = JSON.stringify([
                    0,
                    event['pubkey'],
                    event['create_at'],
                    event['kind'],
                    event['tags'],
                    event['content']
                ]);
                event.id = bytesToHex(
                    await sha256((new TextEncoder().encode(eventData)))
                );
                event.sig = await schnorr.sign(event.id, pri_key);
                return event;
            }

            //==============================================================

            accountToggle.addEventListener('click', function() {
                accountOptions.classList.toggle('active');
            });
        </script>
    </body>
</html>
