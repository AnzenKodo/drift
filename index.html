<!doctype html>

<html>
    <head>
        <title>DriftView</title>
        <meta charset="UTF-8" />
        <script src="https://bundle.run/noble-secp256k1@1.2.14"></script>
        <script src="https://bundle.run/browserify-cipher@1.0.1"></script>
        <style></style>
    </head>
    <body>
        <h1>DriftView</h1>
        <div>
            <button onclick="getPublicKey();">Hello</button>
        </div>
        <!-- <script src="./script.js"></script> -->
        <script>
            function now() {
                return Math.floor(Date.now() / 1000);
            }
            function hexToBytes(hex) {
                return Uint8Array.from(
                    hex.match(/.{1,2}/g).map((byte) => parseInt(byte, 16))
                );
            }
            function bytesToHex(bytes) {
                return bytes.reduce(
                    (str, byte) => str + byte.toString(16).padStart(2, "0"), ""
                )
            }

            let pubKey = "";
            async function getPublicKey() {
                pubKey = await window.nostr.getPublicKey();
            }

            // const { getSharedSecret, schnorr, utils } = nobleSecp256k1;
            // const sha256 = nobleSecp256k1.utils.sha256;
            // // const privKey = myPrivKey;
            // const privKey = bytesToHex(nobleSecp256k1.utils.randomPrivateKey());
            // let pubKey = nobleSecp256k1.getPublicKey(privKey, true);
            // pubKey = pubKey.substring(2);
            // console.log(privKey);

            // const relay = "wss://nos.lol/";
            // const socket = new WebSocket(relay);

            // socket.addEventListener('open', async function( e ) {
            //     console.log("connected to " + relay);
            //     const subId = bytesToHex(nobleSecp256k1.utils.randomPrivateKey()).substring(0, 16);
            //     const filter  = { "authors": [ pubKey ] }
            //     const subscription = [ "REQ", subId, filter ]
            //     console.log('Subscription:', subscription);
            //     socket.send(JSON.stringify(subscription));

            //     socket.send(JSON.stringify(subscription));
            //     const event = {
            //         "content": "Hello World!",
            //         "created_at": now(),
            //         "kind": 1,
            //         "tags": [],
            //         "pubkey": pubKey
            //     }

            //     const signedEvent = await getSignedEvent(event, privKey);
            //     console.log("signedEvent:", signedEvent);
            //     socket.send(JSON.stringify(["EVENT", signedEvent]));
            // });

            // socket.addEventListener('message', async function(message) {
            //     const [ type, subId, event ] = JSON.parse(message.data);
            //     const { kind, content } = event || {}
            //     if (!event || event === true) return;
            //     console.log('message:', event);
            //     if (kind === 4) {
            //         content = await decrypt(privKey, event.pubkey, content);
            //     }
            //     console.log('content:', content);
            // });

            // async function getSignedEvent(event, privateKey) {
            //     var eventData = JSON.stringify([
            //         0,
            //         event['pubkey'],
            //         event['create_at'],
            //         event['kind'],
            //         event['tags'],
            //         event['content']
            //     ]);
            //     event.id = bytesToHex(
            //         await sha256((new TextEncoder().encode(eventData)))
            //     );
            //     event.sig = await schnorr.sign(event.id, privateKey);
            //     return event;
            // }
        </script>
    </body>
</html>
